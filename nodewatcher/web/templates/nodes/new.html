{% extends "my_base.html" %}
{% load i18n %}
{% load gmap %}

{% block title %}{% trans "New Node Registration" %}{% endblock %}
{% block heading %}{% trans "New Node Registration" %}{% endblock %}

{% block my_content %}
{% with "register a new node" as form_errors_context %}
{% include "form_errors.html" %}
{% endwith %}

<p class="no-top-margin">
  {% url nodes_list as nodes_list %}{% blocktrans %}Please provide some basic information about your newly established node. Node's name should reflect its location and/or purpuse. As a guideline, consider using lowercased <i>street names</i> (for some examples, please see <a href="{{ nodes_list }}" rel="external">the existing node list</a>). After your node is registered you will be able to generate a flashable image for use with your router hardware. A subnet will be automatically assigned to your node as you complete the registration procedure.{% endblocktrans %}
</p>

<form action="{% url new_node %}" method="post">
{% csrf_token %}
<table border="0" width="700">
  <tr>
    <td class="first_column_width">{{ form.name.label }}</td>
    <td>{{ form.name }}</td>
  </tr>
  {% if user.is_staff %}
  <tr>
    <td>{{ form.ip.label }}</td>
    <td>{{ form.ip }}</td>
  </tr>
  <tr>
    <td></td>
    <td><label onclick="toggleIpInput();">{{ form.assign_ip }} {{ form.assign_ip.label }}</label></td>
  </tr>
  {% else %}
  <tr>
    <td>{{ form.ip.label }}</td>
    <td><b>{% trans "auto-assigned" %}</b></td>
  </td>
  {% endif %}
  <tr>
    <td>{{ form.project.label }}</td>
    <td>{{ form.project }}</td>
  </tr>
  <tr>
    <td>{{ form.pool.label }}</td>
    <td>{{ form.pool }}</td>
  </tr>
  <tr>
    <td>{{ form.node_type.label }}</td>
    <td>{{ form.node_type }}</td>
  </tr>
  <tr class="location_opts">
    <td>{{ form.location.label }}</td>
    <td>{{ form.location }}</td>
  </tr>
  <tr class="location_opts">
    <td></td>
    <td class="small_text">{% trans "Should be an address where the node is located." %}</td>
  </tr>
  <tr class="location_opts">
    <td></td>
    <td><div id="gmap" style="width:398px; height: 298px; margin: 2px;"></div></td>
  </tr>
  <tr class="location_opts">
    <td>{{ form.geo_lat.label }}</td>
    <td>{{ form.geo_lat }}</td>
  </tr>
  <tr class="location_opts">
    <td>{{ form.geo_long.label }}</td>
    <td>{{ form.geo_long }}</td>
  </tr>
  <tr class="location_opts">
    <td></td>
    <td class="small_text">Click on the map or enter coordinates in <a href="{{ documentation_links.decimal_degrees }}" rel="external">decimal degrees</a> format.</td>
  </tr>
  <tr class="section_title">
    <td colspan="2">{% trans "Antenna Information" %}</td>
  </tr>
  <tr>
    <td>{{ form.ant_external.label }}</td>
    <td>{{ form.ant_external }}</td>
  </tr>
  <tr class="extantenna_opts">
    <td>{{ form.ant_type.label }}</td>
    <td>{{ form.ant_type }}</td>
  </tr>
  <tr class="extantenna_opts">
    <td>{{ form.ant_polarization.label }}</td>
    <td>{{ form.ant_polarization }}</td>
  </tr>
  <tr class="extantenna_opts">
    <td>{{ form.ant_conn.label }}</td>
    <td>{{ form.ant_conn }} (<a href="{{ documentation_links.diversity }}" rel="external">what is this?</a>)</td>
  </tr>
  <tr class="section_title">
    <td colspan="2">{% trans "Additional Options" %}</td>
  </tr>
  {% if user.is_staff %}
  <tr>
    <td>{{ form.system_node.label }}</td>
    <td>{{ form.system_node }}</td>
  </tr>
  <tr>
    <td>{{ form.border_router.label }}</td>
    <td>{{ form.border_router }}</td>
  </tr>
  {% endif %}
  <tr>
    <td>{{ form.redundancy_req.label }}</td>
    <td>{{ form.redundancy_req }}</td>
  </tr>
  <tr>
    <td></td>
    <td class="small_text">{% trans "Warn if node has no direct peering with a border gateway (includes VPN servers)." %}</td>
  </tr>
  <tr class="section_title">
    <td colspan="2">{% trans "Image Generator Options" %}</td>
  </tr>
  <tr>
    <td>{{ form.template.label }}</td>
    <td>{{ form.template }}</td>
  </tr>
  <tr>
    <td></td>
    <td class="small_text">
      {% blocktrans %}You can leave it unconfigured if you are using custom firmware or hardware and you are not
      interested in automatic image building. Maybe use notes field bellow to describe node software, hardware and
      configuration.{% endblocktrans %}
    </td>
  </tr>
  <tr class="imagegen_opts">
    <td>{{ form.channel.label }}</td>
    <td>{{ form.channel }}</td>
  </tr>
  <tr class="imagegen_opts">
    <td>{{ form.use_vpn.label }}</td>
    <td>{{ form.use_vpn }}</td>
  </tr>
  <tr class="imagegen_opts vpn_opts">
    <td>{{ form.tc_egress.label }}</td>
    <td>{{ form.tc_egress }}</td>
  </tr>
  <tr class="imagegen_opts vpn_opts">
    <td>{{ form.tc_ingress.label }}</td>
    <td>{{ form.tc_ingress }}</td>
  </tr>
  <tr class="imagegen_opts vpn_opts">
    <td></td>
    <td class="small_text">This will setup traffic limiting on VPN gateways. Set limits only if and when you notice problems with Internet connection sharing because of the node. In general this is not needed as traffic is already limited by other factors (like wireless connections quality).</td>
  </tr>
  <tr class="imagegen_opts">
    <td>{{ form.wan_dhcp.label }}</td>
    <td>{{ form.wan_dhcp }}</td>
  </tr>
  <tr class="imagegen_opts">
    <td></td>
    <td class="small_text">If you will not use WAN port leave it auto-configured.</td>
  </tr>
  <tr class="static_opts imagegen_opts" style="display: none;">
    <td>{{ form.wan_ip.label }}</td>
    <td>{{ form.wan_ip }}</td>
  </tr>
  <tr class="static_opts imagegen_opts" style="display: none;">
    <td>{{ form.wan_gw.label }}</td>
    <td>{{ form.wan_gw }}</td>
  </tr>
  <tr class="imagegen_opts">
    <td>{{ form.root_pass.label }}</td>
    <td>{{ form.root_pass }}</td>
  </tr>
  <tr class="imagegen_opts">
    <td></td>
    <td class="small_text">{% trans "This password is used for remote maintenance access to the node. <b>Do not share it with anybody as it can compromise node's and network's security!</b> It will be accessible (to view or change) later through <i>edit node</i> page to node's maintainer (that's you)." %}</td>
  </tr>
  <tr class="imagegen_opts">
    <td valign="top">{{ form.optional_packages.label }}</td>
    <td class="optional_packages">{{ form.optional_packages }}</td>
  </tr>
  <tr>
    <td valign="top">{{ form.notes.label }}</td>
    <td>{{ form.notes }}</td>
  </tr>
  <tr>
    <td></td>
    <td class="small_text">
      {% blocktrans %}These notes are only visible to node's maintainer (that's you). They are public if the node is marked
      as dead and should describe background of node's death.{% endblocktrans %}
    </td>
  </tr>
  <tr>
    <td>{{ form.url.label }}</td>
    <td>{{ form.url }}</td>
  </tr>
  <tr>
    <td></td>
    <td class="small_text">{% trans "You may enter any URL that will be displayed on node's info page." %}</td>
  </tr>
</table>
<div class="buttons"><input type="submit" value="{% trans "Register new node" %}" /></div>
</form>
{% endblock %}

{% block js %}
<script type="text/javascript">
/* <![CDATA[ */
  var mobileNodeType = {{ mobile_node_type }};
  var projects = {
  {% for project in projects %}{% if project.has_geoloc %}
    {% ifchanged "" %}{% else %},{% endifchanged %}
    {{ project.id }} : {
      "lat": {{ project.geo_lat }},
      "long": {{ project.geo_long }},
      "zoom": {{ project.geo_zoom }}
    }
  {% endif %}{% endfor %}
  };
  var pools = {
  {% for project in projects %}
    {{ project.id }} : {
      "default" : {{ project.pool.pk }},
      "list" : [
      {% for pool in project.get_pools %}
        {
          "id" : {{ pool.id }},
          "subnet" : '{{ pool.ip_subnet }}',
          "description" : '{{ pool.description }}',
          "prefix_len" : {{ pool.default_prefix_len }}
        }{% if not forloop.last %},{% endif %}
      {% endfor %}
      ]
    }{% if not forloop.last %},{% endif %}
  {% endfor %}
  };
{% if user.is_staff %}
  $(document).ready(function () {
    $('#id_assign_ip').onchange = toggleIpInput;
    toggleIpInput();
  });
{% endif %}
/* ]]> */
</script>
<script type="text/javascript" src="{{ MEDIA_URL }}js/node.js"></script>
{% do_gmap "mapInit" %}
{% endblock %}
