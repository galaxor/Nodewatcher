{% extends "my_base.html" %}
{% load i18n %}
{% load gmap %}
{% load misc %}

{% block title %}{% trans "New Node Registration" %}{% endblock %}
{% block heading %}{% trans "New Node Registration" %}{% endblock %}

{% block my_content %}
{% with "register a new node" as form_errors_context %}
{% with "no-top-margin" as classes %}
{% include "form_errors.html" %}
{% endwith %}
{% endwith %}

{% notice "" "no-top-margin" %}
{% url nodes_list as nodes_list %}{% blocktrans %}If you are unsure about any option just leave it at its default value.{% endblocktrans %}
{% endnotice %}

<h2>{% trans "General Information" %}</h2>
<form action="{% url new_node %}" method="post">
{% csrf_token %}
<table border="0" width="700">
  <tr>
    <td class="first_column_width">{{ form.node_type.label }}</td>
    <td>{{ form.node_type }}</td>
  </tr>
  <tr>
    <td>{{ form.project.label }}</td>
    <td>{{ form.project }}</td>
  </tr>
  <tr>
    <td></td>
    <td class="small_text">{% blocktrans %}Project (pre)defines different aspects of the node (initial location, IP pools, splash screen, SSID, installed packages...).{% endblocktrans %}</td>
  </tr>
  <tr>
    <td>{{ form.name.label }}</td>
    <td>{{ form.name }}</td>
  </tr>
  <tr>
    <td></td>
    <td class="small_text">{% url nodes_list as nodes_list %}{% blocktrans %}Name will be automatically filled if you enter the <i>Location</i> first. Name should represent location of the node or a common name of the space (building, park...) where the node is. Please refer to <a href="{{ nodes_list }}" rel="external">existing nodes</a> for examples.{% endblocktrans %}</td>
  </tr>
  <tr class="location_opts">
    <td>{{ form.location.label }}</td>
    <td>{{ form.location }}</td>
  </tr>
  <tr class="location_opts">
    <td></td>
    <td class="small_text">{% trans "Should be an address where the node is located. Please do not enter generic parts of the address like <i>street</i> or <i>road</i>, but do enter <i>square</i> and other uncommon types." %}</td>
  </tr>
  <tr class="location_opts">
    <td></td>
    <td><div id="gmap" style="width:398px; height: 298px; margin: 2px;"></div></td>
  </tr>
  <tr class="location_opts">
    <td></td>
    <td class="small_text">{% trans "Use <i>Hybrid</i> view to position the node precisely (on the roof, balcony, window...)." %}</td>
  </tr>
  <tr class="location_opts">
    <td>{{ form.geo_lat.label }}</td>
    <td>{{ form.geo_lat }}</td>
  </tr>
  <tr class="location_opts">
    <td>{{ form.geo_long.label }}</td>
    <td>{{ form.geo_long }}</td>
  </tr>
  <tr class="location_opts">
    <td></td>
    <td class="small_text">Click on the map or enter coordinates in <a href="{{ documentation_links.decimal_degrees }}" rel="external">decimal degrees</a> format.</td>
  </tr>
  <tr>
    <td>{{ form.url.label }}</td>
    <td>{{ form.url }}</td>
  </tr>
  <tr>
    <td></td>
    <td class="small_text">{% trans "You may enter any URL that will be displayed on the node's page." %}</td>
  </tr>
</table>

<h3>{% trans "Notes" %}</h3>
<table border="0" width="700">
  <tr>
    <td>{{ form.notes }}</td>
  </tr>
  <tr>
    <td class="small_text">
      {% blocktrans %}These notes are only visible to node's maintainer (that's you). They are public if the node is marked
      as dead and should describe background of node's death.{% endblocktrans %}
    </td>
  </tr>
</table>

<h3>{% trans "Node in the Network" %}</h3>
<table border="0" width="700">
  <tr>
    <td class="first_column_width">{{ form.pool.label }}</td>
    <td>{{ form.pool }}</td>
  </tr>
  <tr>
    <td></td>
    <td class="small_text">{% blocktrans with documentation_links.ip_address as ip_address %}Select from which IP pool node is assigned its <a href="{{ ip_address }}" rel="external">IP address</a>. Non-default pools are used only for special nodes so default is probably what you want.{% endblocktrans %}</td>
  </tr>  
  {% if user.is_staff %}
    <tr>
      <td>{{ form.ip.label }}</td>
      <td>{{ form.ip }}</td>
    </tr>
    <tr>
      <td></td>
      <td><label onclick="toggleIpInput();">{{ form.assign_ip }} {{ form.assign_ip.label }}</label></td>
    </tr>
    <tr>
      <td>{{ form.system_node.label }}</td>
      <td>{{ form.system_node }}</td>
    </tr>
    <tr>
      <td>{{ form.border_router.label }}</td>
      <td>{{ form.border_router }}</td>
    </tr>
  {% endif %}
  <tr>
    <td>{{ form.redundancy_req.label }}</td>
    <td>{{ form.redundancy_req }}</td>
  </tr>
  <tr>
    <td></td>
    <td class="small_text">{% blocktrans with documentation_links.vpn as vpn %}Warn if the node has no direct connection to a border gateway (this includes also <a href="{{ vpn }}" rel="external">VPN</a> servers). This is useful if the node is connected to the network in multiple ways and you want to be warned when a <a href="{{ vpn }}" rel="external">VPN</a> connection fails.{% endblocktrans %}</td>
  </tr>  
</table>

<h2>{% trans "Details" %}</h2>

<h3>{% trans "Antenna Information" %}</h3>
<table border="0" width="700">
  <tr>
    <td class="first_column_width">{{ form.ant_external.label }}</td>
    <td>{{ form.ant_external }}</td>
  </tr>
  <tr>
    <td></td>
    <td class="small_text">{% trans "Do your node have an external antenna and not just a default antenna which came with your node's router?" %}</td>
  </tr>  
  <tr class="extantenna_opts">
    <td>{{ form.ant_type.label }}</td>
    <td>{{ form.ant_type }}</td>
  </tr>
  <tr class="extantenna_opts">
    <td></td>
    <td class="small_text">{% blocktrans with documentation_links.antenna_type as antenna_type %}Please follow <a href="{{ antenna_type }}" rel="external">this link</a> to learn more about antenna types.{% endblocktrans %}</td>
  </tr>  
  <tr class="extantenna_opts">
    <td>{{ form.ant_polarization.label }}</td>
    <td>{{ form.ant_polarization }}</td>
  </tr>
  <tr class="extantenna_opts">
    <td></td>
    <td class="small_text">{% blocktrans with documentation_links.antenna_polarization as antenna_polarization %}Please follow <a href="{{ antenna_polarization }}" rel="external">this link</a> to learn more about antenna polarization.{% endblocktrans %}</td>
  </tr>  
</table>

<h3>{% trans "Image Generator Options" %}</h3>
<table border="0" width="700">
  <tr>
    <td class="first_column_width">{{ form.template.label }}</td>
    <td>{{ form.template }}</td>
  </tr>
  <tr>
    <td></td>
    <td class="small_text">
      {% blocktrans with network.contact_page as contact_page %}Select the router type you are using for your node.
      You can leave it unconfigured if you are using a custom firmware or hardware and you are not interested in automatic
      image building. Maybe use notes field above to describe node's software, hardware and configuration. If you would like
      to use unsupported router please <a href="{{ contact_page }}">contact us</a> and we will see what we can do.{% endblocktrans %}
    </td>
  </tr>
  <tr class="imagegen_opts">
    <td>{{ form.channel.label }}</td>
    <td>{{ form.channel }}</td>
  </tr>
  <tr class="imagegen_opts">
    <td></td>
    <td class="small_text">{% trans "Wireless channel (frequency) to use. The node can connect only with other nodes on the same channel so for maximum connectivity leave it on the default channel. The drawback is lower throughput in the network." %}</td>
  </tr>
  <tr class="imagegen_opts extantenna_opts">
    <td>{{ form.ant_conn.label }}</td>
    <td>{{ form.ant_conn }}</td>
  </tr>
  <tr class="imagegen_opts extantenna_opts">
    <td></td>
    <td class="small_text">{% blocktrans with documentation_links.diversity as diversity %}Default is what is recommended to use as it chooses the best option for your router. You can find more explanation <a href="{{ diversity }}" rel="external">here</a>.{% endblocktrans %}</td>
  </tr>  
  <tr class="imagegen_opts">
    <td>{{ form.use_vpn.label }}</td>
    <td>{{ form.use_vpn }}</td>
  </tr>
  <tr class="imagegen_opts">
    <td></td>
    <td class="small_text">{% blocktrans with documentation_links.vpn as vpn %}<a href="{{ vpn }}" rel="external">VPN</a> is used to connect the node to the network also over your Internet connection. By enabling <a href="{{ vpn }}" rel="external">VPN</a> you can connect WAN port of the node's router to your Internet router and node will use it. You can safely leave this enabled even if you do not intend to share your Internet connection.{% endblocktrans %}</td>
  </tr>
  <tr class="imagegen_opts vpn_opts">
    <td>{{ form.tc_egress.label }}</td>
    <td>{{ form.tc_egress }}</td>
  </tr>
  <tr class="imagegen_opts vpn_opts">
    <td>{{ form.tc_ingress.label }}</td>
    <td>{{ form.tc_ingress }}</td>
  </tr>
  <tr class="imagegen_opts vpn_opts">
    <td></td>
    <td class="small_text">{% blocktrans with documentation_links.vpn as vpn %}You can setup limiting for connections to <a href="{{ vpn }}" rel="external">VPN</a> servers and thus how much of your Internet connection the node can maximally consume. Set limits only if and when you notice problems with Internet connection sharing because of the node (use graphs on node's page to evaluate this). In general this is not needed as traffic is already limited by other factors (like wireless connections quality).{% endblocktrans %}</td>
  </tr>
  <tr class="imagegen_opts">
    <td>{{ form.wan_dhcp.label }}</td>
    <td>{{ form.wan_dhcp }}</td>
  </tr>
  <tr class="imagegen_opts">
    <td></td>
    <td class="small_text">When you connect WAN port of the node's router to your Internet router do you want it to be auto-configured? Even if you are not using WAN port leave it on the default, auto-configured.</td>
  </tr>
  <tr class="imagegen_opts static_opts">
    <td>{{ form.wan_ip.label }}</td>
    <td>{{ form.wan_ip }}</td>
  </tr>
  <tr class="imagegen_opts static_opts">
    <td>{{ form.wan_gw.label }}</td>
    <td>{{ form.wan_gw }}</td>
  </tr>
  <tr class="imagegen_opts">
    <td>{{ form.root_pass.label }}</td>
    <td>{{ form.root_pass }}</td>
  </tr>
  <tr class="imagegen_opts">
    <td></td>
    <td class="small_text">{% trans "This password is used for remote maintenance access to the node. <b>Do not share it with anybody as it can compromise node's and network's security!</b> It will be accessible (to view or change) later through <i>Edit node</i> page to node's maintainer (that's you)." %}</td>
  </tr>
  <tr class="imagegen_opts">
    <td valign="top">{{ form.optional_packages.label }}</td>
    <td class="optional_packages">{{ form.optional_packages }}</td>
  </tr>
  <tr class="imagegen_opts">
    <td></td>
    <td class="small_text">{% blocktrans with network.contact_page as contact_page %}You can install additional packages on the node's router and thus gain additional functionality. If you are missing some package you would like to use or would like to use your own package please <a href="{{ contact_page }}" rel="external">contact us</a> and we will try to add it.{% endblocktrans %}</td>
  </tr>
</table>
<div class="buttons"><input type="submit" value="{% trans "Register" %}" /></div>
</form>
{% endblock %}

{% block js %}
<script type="text/javascript">
/* <![CDATA[ */
  var mobileNodeType = {{ mobile_node_type }};
  var deadNodeType = {{ dead_node_type }};
  var projects = {
  {% for project in projects %}{% if project.has_geoloc %}
    {% ifchanged "" %}{% else %},{% endifchanged %}
    {{ project.id }} : {
      "lat": {{ project.geo_lat }},
      "long": {{ project.geo_long }},
      "zoom": {{ project.geo_zoom }}
    }
  {% endif %}{% endfor %}
  };
  var pools = {
  {% for project in projects %}
    {{ project.id }} : {
      "default" : {{ project.pool.pk }},
      "list" : [
      {% for pool in project.get_pools %}
        {
          "id" : {{ pool.id }},
          "subnet" : '{{ pool.ip_subnet }}',
          "description" : '{{ pool.description }}',
          "prefix_len" : {{ pool.default_prefix_len }}
        }{% if not forloop.last %},{% endif %}
      {% endfor %}
      ]
    }{% if not forloop.last %},{% endif %}
  {% endfor %}
  };
{% if user.is_staff %}
  $(document).ready(function () {
    $('#id_assign_ip').change(function(event) { toggleIpInput(); return true; });
    toggleIpInput();
  });
{% endif %}
/* ]]> */
</script>
<script type="text/javascript" src="{{ MEDIA_URL }}js/n11ndata.js"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}js/n11n.js"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}js/unidecode.js"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}js/node.js"></script>
{% do_gmap "mapEditInit" "mapClick" %}
{% endblock %}
