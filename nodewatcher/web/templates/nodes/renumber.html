{% extends "base.html" %}
{% load i18n %}

{% block title %}{% blocktrans with node.name|default:_("unknown") as node_name %}Renumber Node {{ node_name }}{% endblocktrans %}{% endblock %}
{% block heading %}{% url view_node node.pk as node_url %}{% blocktrans with node.name|default:_("unknown") as node_name %}Renumber Node <a href="{{ node_url }}">{{ node_name }}</a>{% endblocktrans %}{% endblock %}

{% block content %}

<div class="error">
 {% trans "<b>WARNING:</b> By renumbering this node you will put node's old allocated subnets back into the pool! After you renumber you must <b>update the router's configuration</b> to reflect renumbering changes. You can simply generate a new image with new configuration for your router and flash it." %}
</div>
 
{% include "nodes/general_info.html" %}

<h3>{% trans "Renumber Specification" %}</h3>
{% if form.errors %}
<div class="error">
  {% blocktrans %}<b>Oooops!</b> The following errors have ocurred while attempting to renumber this node:{% endblocktrans %}<br />
  <br/>
  {% for error in form.non_field_errors %}
  <i>{{ error|escape }}</i><br/>
  {% endfor %}
  {% for field in form %}
  {% for error in field.errors %}
  {{ field.label }}: <i>{{ error|escape }}</i><br/>
  {% endfor %}
  {% endfor %}
</div>
{% endif %}
{% if form.warnings %}
<div class="warning">
  {% blocktrans %}<b>WARNING:</b> Renumbering procedure has encountered some non-fatal potential problems. Please review them and resubmit this form if they are acceptable (otherwise abort this operation).{% endblocktrans %}<br/>
  <br/>
  {% for warning in form.warnings %}
  <i>{{ warning }}</i><br/>
  {% endfor %} 
</div>
{% endif %}

<form method="post" action="{% url renumber_node node.pk %}">
{% csrf_token %}
<div style='display:none'>{{ form.confirm_all_warnings }}</div>
<table border="0" width="700">
  <tr>
    <td class="first_column_width"><b>{% trans "Current allocation" %}</b></td>
    <td><b>{% trans "Renumber action" %}</b></td>
  </tr>
  {% for subnet in form.get_subnet_fields %}
  <tr>
    <td valign="top">{{ subnet.model }}</td>
    <td>
      {{ subnet }}
      <div class="prefix_len_{{ subnet.prefix }}">
        {% trans "New prefix length:" %}&nbsp;
        <select name="{{ subnet.prefix }}" id="id_{{ subnet.prefix }}"></select>
        {% if user.is_staff %}
        <br/>{% trans "Subnet (optional):" %}&nbsp;
        {{ subnet.manual_ip }}
        {% endif %}
      </div>
    </td>
  </tr>
  {% endfor %}
</table>

<script type="text/javascript">
/* <![CDATA[ */
  var pool_prefix_lens = {
    {% for pool in form.get_pools %}
    {{ pool.id }} : {
      'min' : {{ pool.min_prefix_len }},
      'max' : {{ pool.max_prefix_len }},
      'def' : {{ pool.default_prefix_len }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  };
  
  function updatePrefixLensForPool(subnetId, action) {
    if (action <= 0) {
      $('.prefix_len_prefix_' + subnetId).css('display', 'none');
    } else {
      var prefs = $('#id_prefix_' + subnetId); 
      $('.prefix_len_prefix_' + subnetId).css('display', '');
      prefs.empty();
      
      pool = pool_prefix_lens[action];
      for (var i = pool.min; i <= pool.max; i++) {
        prefs.append('<option value="' + i + '">/' + i + '</option>');
      }
      prefs.attr('value', '' + pool.def);
    }
  }
  
  $(document).ready(function () {
    $('.subnet').change(function(event) {
      var subnetId = $(this).attr('id').replace('id_subnet_', '');
      updatePrefixLensForPool(subnetId, $(this).attr('value'));
    }).change();
  });
/* ]]> */
</script>

<div class="buttons">
  <input type="submit" value="{% trans "Renumber" %}" />&nbsp;
  <input type="button" value="{% trans "Cancel" %}" onclick="document.location='{% url view_node node.pk %}'" />
</div>
</form>
{% endblock %}
