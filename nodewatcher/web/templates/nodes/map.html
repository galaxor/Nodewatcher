{% extends "base.html" %}
{% load i18n %}
{% load gmap %}

{% block title %}{% trans "Mesh Map View" %}{% endblock %}

{% block content %}
<h1>{% trans "Mesh Map View" %}</h1>
<br/>
<script>
  var icons = {};

  function create_icon(status)
  {
    if (icons[status])
      return icons[status];

    icon = new GIcon();
    icon.image = "/images/gmap_node_"+status+".png";
    icon.shadow = "/images/gmap_node_shadow.png";
    icon.iconSize = new GSize(20, 32);
    icon.shadowSize = new GSize(32, 32);
    icon.iconAnchor = new GPoint(9, 30);
    icon.infoWindowAnchor = new GPoint(10, 2);
    icons[status] = icon;
    return icon;
  }

  function create_marker(map, lat, lon, ip, name, status, urlinfo)
  {
    var opts = { title : name + " (" + ip + ")", "icon" : create_icon(status) };
    var m = new GMarker(new GLatLng(lat, lon), opts);
    GEvent.addListener(m, "click", function() {
      html = "<b>" + name + "</b> (" + ip + ")<div class=\"gmap_details\">Status: <span class=\"node_status_" +
           status + "\">" + status + "</span><br><a href=\"/nodes/node/" + ip +"\" target=\"_blank\">more information</a>";
      if (urlinfo) 
       html = html + " | <a href=\"" + urlinfo + "\" target=\"_blank\">{% trans "visit info page" %}</a>";
      m.openInfoWindowHtml(html + "</div>");
    });
    map.addOverlay(m);
  }

  function create_link(map, lat1, lon1, lat2, lon2, color)
  {
    var p = new GPolyline([
      new GLatLng(lat1, lon1),
      new GLatLng(lat2, lon2)
    ], color, 5);
    map.addOverlay(p);
  }

  function populate_map(map)
  {

    /* Nodes */
    {% for node in nodes %}
    {% if node.should_draw_on_map %}
    create_marker(map, {{ node.geo_lat }}, {{ node.geo_long }}, '{{ node.ip }}', '{{ node.name }}', '{{ node.status_as_string }}', '{{ node.url }}');
    {% endif %}
    {% endfor %}

    /* Links */
    {% for link in links %}
    {% if link.should_draw_on_map %}
    create_link(map, {{ link.src.geo_lat }}, {{ link.src.geo_long }}, {{ link.dst.geo_lat }}, {{ link.dst.geo_long }}, '{{ link.color }}');
    {% endif %}
    {% endfor %}
  }
</script>
<div style="margin-left: 10px;">
{% gmap lat:46.05 long:14.5 full:yes callback:populate_map %}
</div>
<br/>
<br/>
{% trans "Edge color key" %}:<br/>
<ul>
  <li><font color='#00ff00'>{% trans "green" %}</font> - {% trans "ETX is between 1.0 and 2.0" %}</li>
  <li><font color='#0000ff'>{% trans "blue" %}</font> - {% trans "ETX is greater than 2.0 and lower or equal to 5.0" %}</li>
  <li><font color='#ff0000'>{% trans "red" %}</font> - {% trans "ETX is greater than 5.0" %}</li>
</ul>
<br/>
<br/><br/><br/><br/>
{% endblock %}
